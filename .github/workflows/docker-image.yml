name: Build Cloudreve Docker Image

# 触发条件：手动触发（点击 Run workflow 才执行）
on:
  workflow_dispatch:
    inputs:
      # 可选：允许手动输入 Cloudreve 版本（默认用 4.10.1，和你下载的包一致）
      cloudreve_version:
        description: 'Cloudreve 版本'
        required: true
        default: '4.10.1'

jobs:
  build:
    runs-on: ubuntu-latest  # 用 GitHub 提供的 Ubuntu 服务器构建
    
    steps:
      # 第一步：拉取你仓库的代码（包含 Cloudreve 压缩包和 Dockerfile）
      - name: Checkout code
        uses: actions/checkout@v4
        
      # 第二步：设置 Docker 构建环境
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        
      # 第三步：构建 Docker 镜像
      - name: Build Docker image
        uses: docker/build-push-action@v5
        with:
          context: .  # 构建上下文：当前仓库根目录（你的 Cloudreve 包和 Dockerfile 要在这里）
          push: false  # 不推送到 Docker 仓库（只在本地构建后导出）
          load: true   # 构建完成后加载到本地 Docker 环境，方便后续导出
          tags: cloudreve:custom  # 镜像名称+标签（和你之前计划的一致）
          
      # 第四步：导出镜像为 tar 文件（供下载到极空间）
      - name: Save Docker image to tar
        run: |
          docker save -o cloudreve_custom.tar cloudreve:custom
          
      # 第五步：上传 tar 文件到 GitHub Actions 产物（方便你下载）
      - name: Upload image tar
        uses: actions/upload-artifact@v4
        with:
          name: cloudreve-docker-image
          path: cloudreve_custom.tar  # 要上传的文件路径
          retention-days: 7  # 产物保留 7 天，足够你下载
